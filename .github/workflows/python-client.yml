name: Python Client

on:
  push:
    tags:
      - 'v*.*.*'
    branches:
      - main

permissions:
  contents: read

jobs:
  linux:
    runs-on: ${{ matrix.platform.runner }}
    env:
      PYO3_USE_ABI3_FORWARD_COMPATIBILITY: 1
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10"]
        platform:
          - runner: ubuntu-22.04
            target: x86_64
            container: quay.io/pypa/manylinux2014_x86_64:latest
            test-on-docker-platform: linux/amd64
          - runner: ubuntu-22.04
            target: aarch64
            container: quay.io/pypa/manylinux2014_aarch64:latest
            test-on-docker-platform: linux/arm64
    #          - runner: ubuntu-22.04
    #            target: armv7
    #          - runner: ubuntu-22.04
    #            target: s390x
    #          - runner: ubuntu-22.04
    #            target: ppc64le
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Setup QEMU
        if: matrix.platform.target != 'x86_64'
        uses: docker/setup-qemu-action@v1

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.platform.target }}
          args: --release --out dist --manifest-path umadb-python/Cargo.toml -i python${{ matrix.python-version }}
          #          sccache: ${{ !startsWith(github.ref, 'refs/tags/') }}
          manylinux: auto
          container: ${{ matrix.platform.container }}
          before-script-linux: |
            PROTOC_VERSION=33.1
            case "$(uname -m)" in
              x86_64)  PROTOC_ZIP="protoc-${PROTOC_VERSION}-linux-x86_64.zip" ;;
              aarch64) PROTOC_ZIP="protoc-${PROTOC_VERSION}-linux-aarch_64.zip" ;;
              armv7l)  PROTOC_ZIP="protoc-${PROTOC_VERSION}-linux-armv7.zip" ;;
              i686)    PROTOC_ZIP="protoc-${PROTOC_VERSION}-linux-x86_32.zip" ;;
              *) echo "Unsupported arch: $(uname -m)" >&2; exit 1 ;;
            esac
            curl -LO "https://github.com/protocolbuffers/protobuf/releases/download/v${PROTOC_VERSION}/${PROTOC_ZIP}"
            mkdir -p "$HOME/protoc"
            python3 - "$PROTOC_ZIP" "$HOME/protoc" <<'PYCODE'
            import zipfile, sys, os
            with zipfile.ZipFile(sys.argv[1]) as zf:
                zf.extractall(sys.argv[2])
            PYCODE
            chmod +x "$HOME/protoc/bin/protoc"
            export PATH="$HOME/protoc/bin:$PATH"

      - name: Test built wheel
        run: |
          pip install umadb --no-index --find-links dist --force-reinstall
          python -c "import umadb"

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-linux-${{ matrix.python-version }}-${{ matrix.platform.target }}
          path: dist


  musllinux:
    runs-on: ${{ matrix.platform.runner }}
    env:
      PYO3_USE_ABI3_FORWARD_COMPATIBILITY: 1
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10"]
        platform:
          - runner: ubuntu-22.04
            target: x86_64
          - runner: ubuntu-22.04
            target: aarch64
    #          - runner: ubuntu-22.04
    #            target: armv7
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Setup QEMU
        if: matrix.platform.target != 'x86_64'
        uses: docker/setup-qemu-action@v1

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.platform.target }}
          args: --release --out dist --manifest-path umadb-python/Cargo.toml -i python${{ matrix.python-version }}
          #          sccache: ${{ !startsWith(github.ref, 'refs/tags/') }}
          manylinux: musllinux_1_2
          before-script-linux: |
            PROTOC_VERSION=33.1
            case "$(uname -m)" in
              x86_64)  PROTOC_ZIP="protoc-${PROTOC_VERSION}-linux-x86_64.zip" ;;
              aarch64) PROTOC_ZIP="protoc-${PROTOC_VERSION}-linux-aarch_64.zip" ;;
              armv7l)  PROTOC_ZIP="protoc-${PROTOC_VERSION}-linux-armv7.zip" ;;
              i686)    PROTOC_ZIP="protoc-${PROTOC_VERSION}-linux-x86_32.zip" ;;
              *) echo "Unsupported arch: $(uname -m)" >&2; exit 1 ;;
            esac
            curl -LO "https://github.com/protocolbuffers/protobuf/releases/download/v${PROTOC_VERSION}/${PROTOC_ZIP}"
            unzip "${PROTOC_ZIP}" -d "$HOME/protoc"
            export PATH="$HOME/protoc/bin:$PATH"

      - name: Test built wheel
        uses: addnab/docker-run-action@v3
        with:
          image: alpine:3.20
          options: |
            -v ${{ github.workspace }}:/work
            --platform ${{ matrix.platform.test-on-docker-platform }}
          run: |
            apk add --no-cache python3 py3-pip
            cd /work/dist
            # Install your musllinux wheel
            pip install *.whl
            # Import test
            python3 -c "import umadb; print('OK')"

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-musllinux-${{ matrix.python-version }}-${{ matrix.platform.target }}
          path: dist


  windows:
    runs-on: ${{ matrix.platform.runner }}
    env:
      PYO3_USE_ABI3_FORWARD_COMPATIBILITY: 1
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10"]
        platform:
          - runner: windows-latest
            target: x64
          - runner: windows-latest
            target: x86
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          architecture: ${{ matrix.platform.target }}

      - name: Install Protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.platform.target }}
          args: --release --out dist --manifest-path umadb-python/Cargo.toml

      - name: Test built wheel
        run: |
          pip install umadb --no-index --find-links dist --force-reinstall
          python -c "import umadb"

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-windows-${{ matrix.python-version }}-${{ matrix.platform.target }}
          path: dist

  macos:
    runs-on: ${{ matrix.platform.runner }}
    env:
      PYO3_USE_ABI3_FORWARD_COMPATIBILITY: 1
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10"]
        platform:
          - runner: macos-latest
            target: aarch64
          - runner: macos-15-intel
            target: x86_64
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Protoc
        uses: arduino/setup-protoc@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.platform.target }}
          args: --release --out dist --manifest-path umadb-python/Cargo.toml
      #          sccache: ${{ !startsWith(github.ref, 'refs/tags/') }}

      - name: Test built wheel
        run: |
          pip install umadb --no-index --find-links dist --force-reinstall
          python -c "import umadb"

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-macos-${{ matrix.python-version }}-${{ matrix.platform.target }}
          path: dist

#  sdist:
#    runs-on: ubuntu-latest
#    steps:
#      - uses: actions/checkout@v4
#
#      - name: Build sdist
#        uses: PyO3/maturin-action@v1
#        with:
#          command: sdist
#          args: --out dist --manifest-path umadb-python/Cargo.toml
#
#      - name: Upload sdist
#        uses: actions/upload-artifact@v4
#        with:
#          name: wheels-sdist
#          path: dist

#  release:
#    name: Release
#    runs-on: ubuntu-latest
#    #    if: ${{ startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch' }}
#    needs: [linux, musllinux, windows, macos, sdist]
#    permissions:
#      # Use to sign the release artifacts
#      id-token: write
#      # Used to upload release artifacts
#      contents: write
#      # Used to generate artifact attestation
#      attestations: write
#    steps:
#      - uses: actions/download-artifact@v4
#      - name: Generate artifact attestation
#        uses: actions/attest-build-provenance@v2
#        with:
#          subject-path: 'wheels-*/*'
#      - name: Publish to PyPI
#        #        if: ${{ startsWith(github.ref, 'refs/tags/') }}
#        uses: PyO3/maturin-action@v1
#        env:
#          MATURIN_PYPI_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
#        with:
#          command: upload
#          args: --non-interactive --skip-existing wheels-*/*
