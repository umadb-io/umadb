name: Build and Release Server Binaries

on:
  push:
    tags:
      - 'v*.*.*'
    branches:
      - main

#  workflow_dispatch:
#    inputs:
#      tag:
#        description: 'Tag to release'
#        required: true

env:
  CARGO_TERM_COLOR: always

jobs:
  build-binaries:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Linux GNU
          - os: ubuntu-latest
            rust_target: x86_64-unknown-linux-gnu
          - os: ubuntu-latest
            rust_target: aarch64-unknown-linux-gnu
          # Linux MUSL
          - os: ubuntu-latest
            rust_target: x86_64-unknown-linux-musl
          - os: ubuntu-latest
            rust_target: aarch64-unknown-linux-musl
#          # macOS
#          - os: macos-latest
#            rust_target: x86_64-apple-darwin
#          - os: macos-latest
#            rust_target: aarch64-apple-darwin

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_target }}

      - name: Build binary
        run: make build-cross-umadb-${{ matrix.rust_target }}

      - name: Test binary
        run: make test-cross-umadb-${{ matrix.rust_target }}

      - name: Archive artifact
        run: |
          cd target/${{ matrix.rust_target }}/release
          if [ "${{ matrix.os }}" = "windows-latest" ]; then
            7z a ../../../umadb-${{ matrix.rust_target }}.zip umadb-${{ matrix.rust_target }}
          else
            tar czf ../../../umadb-${{ matrix.rust_target }}.tar.gz umadb-${{ matrix.rust_target }}
          fi

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: umadb-${{ matrix.rust_target }}
          path: |
            umadb-${{ matrix.rust_target }}.tar.gz
            umadb-${{ matrix.rust_target }}.zip
          if-no-files-found: ignore

  create-release:
    name: Create GitHub Release
    needs: build-binaries
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List downloaded artifacts
        run: ls -R artifacts

#      - name: Create Release
#        uses: softprops/action-gh-release@v1
#        with:
#          tag_name: ${{ github.event.inputs.tag || github.ref_name }}
#          name: Release ${{ github.event.inputs.tag || github.ref_name }}
#          draft: false
#          prerelease: false
#          files: artifacts/**/*.tar.gz

  docker:
    name: Create Docker Images
    runs-on: ubuntu-latest
    needs: build-binaries
    steps:
      - uses: actions/checkout@v4

      - name: Download binaries
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Prepare binaries for Docker
        run: |
          mkdir -p ./binaries/linux/amd64
          mkdir -p ./binaries/linux/arm64

          # Extract Linux x86_64 MUSL binary
          tar xzf artifacts/umadb-x86_64-unknown-linux-musl/umadb-x86_64-unknown-linux-musl.tar.gz -C ./binaries/linux/amd64
          chmod +x ./binaries/linux/amd64/umadb

          # Extract Linux aarch64 MUSL binary
          tar xzf artifacts/umadb-aarch64-unknown-linux-musl/umadb-aarch64-unknown-linux-musl.tar.gz -C ./binaries/linux/arm64
          chmod +x ./binaries/linux/arm64/umadb

          # List for debugging
          ls -lh ./binaries/linux/amd64
          ls -lh ./binaries/linux/arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY_IMAGE_GHCR }},${{ env.REGISTRY_IMAGE_DH }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest,enable=true

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

#      - name: Build and push multi-arch image
#        uses: docker/build-push-action@v6
#        with:
#          context: .
#          file: Dockerfile
#          platforms: linux/amd64,linux/arm64
#          push: true
#          tags: ${{ steps.meta.outputs.tags }}
#          labels: ${{ steps.meta.outputs.labels }}
#          provenance: mode=max
#          sbom: true
